import streamlit as st
import numpy as np

# 1. ç¶²é é…ç½®
st.set_page_config(page_title="UIAå¥½åé‚Š-é•·ç…§è£œåŠ©å°å¹«æ‰‹", page_icon="ğŸ¡", layout="centered")

# --- CSS æ¨£å¼å„ªåŒ– ---
st.markdown("""
    <style>
    h1 { color: #F39800 !important; text-align: center; }
    .stSelectbox div[data-baseweb="select"] { border: 1px solid #F39800; }
    .result-box { text-align: center; padding: 20px; border: 2px solid #F39800; border-radius: 20px; margin: 20px 0; }
    .category-header { color: #2E86C1; border-bottom: 2px solid #AED6F1; padding-bottom: 5px; margin-top: 25px; margin-bottom: 10px; }
    </style>
    """, unsafe_allow_html=True)

st.markdown("<h1>é•·ç…§è£œåŠ©è³‡æ ¼æ¸¬è©•å™¨</h1>", unsafe_allow_html=True)
st.markdown('<div style="text-align: center; color: #666;">ç…§é¡§è·¯ä¸Šï¼Œæ‚¨è¾›è‹¦äº†ï¼è·Ÿè‘—å¥½åé‚Šç°¡å–®è©•ä¼°é•·ç…§ 3.0 è³‡æ ¼ã€‚</div>', unsafe_allow_html=True)

# ---------------------------------------------------------
# 2. æ›´æ–°å¾Œçš„ 10 é …æº«é¦¨é¡Œç›® (åˆ†ä¸‰æ®µå¼é¸é …)
# ---------------------------------------------------------
questions = {
    "ğŸ  å¹³å¸¸åœ¨å®¶å‹•ä¸€å‹•": [
        {"id": "a1", "label": "1. åƒé£¯çš„èƒ½åŠ›", "options": ["å¯ä»¥è‡ªå·±æ‹¿é¤å…·åƒå¾—å¾ˆä¹¾æ·¨", "è¦äººå¹«å¿™å¤¾èœæˆ–åˆ‡ç´°ï¼Œç”šè‡³é¤µå¹¾å£", "æ²’è¾¦æ³•è‡ªå·±åƒï¼Œå®Œå…¨è¦äººé¤µ"]},
        {"id": "a2", "label": "2. æ´—æ¾¡çš„èƒ½åŠ›", "options": ["è‡ªå·±æ´—å¾—å¾ˆé †æ‰‹", "æ´—ä¸åˆ°èƒŒã€æ€•æ»‘å€’ï¼Œè¦äººåœ¨æ—é‚Šçœ‹è‘—æˆ–å¹«å¿™", "å®Œå…¨æ²’æ³•è‡ªå·±æ´—ï¼Œè¦äººå…¨èº«å¹«å¿™"]},
        {"id": "a3", "label": "3. å¤§å°ä¾¿æ§åˆ¶", "options": ["æ§åˆ¶å¾—å¾ˆå¥½ï¼Œä¸æœƒå°¿æ¿•è¤²å­", "å¶çˆ¾æœƒä¾†ä¸åŠè¶•åˆ°å»æ‰€", "å®Œå…¨æ²’è¾¦æ³•æ§åˆ¶ï¼Œéœ€è¦ç”¨å°¿å¸ƒ"]},
        {"id": "a4", "label": "4. ä¸Šå»æ‰€çš„èƒ½åŠ›", "options": ["å¯ä»¥è‡ªå·±é€²å‡ºå»æ‰€ã€ç©¿è„«è¤²å­", "éœ€è¦æ‰¶äººæˆ–æ‰¶æ‰¶æ‰‹ï¼Œç”šè‡³è¦äººå¹«å¿™æ“¦å±è‚¡", "å®Œå…¨æ²’æ³•è‡ªå·±ä¸Šï¼Œè¦åœ¨åºŠä¸Šä½¿ç”¨ä¾¿ç›†"]},
        {"id": "a5", "label": "5. èµ°è·¯èˆ‡çˆ¬æ¨“æ¢¯", "options": ["åœ¨å®¶èµ°å¾—å¾ˆç©©ï¼Œé‚„èƒ½è‡ªå·±ä¸Šä¸‹æ¨“", "è¦æ‹¿æ‹æ–æˆ–æ‰¶æ¡Œå­ï¼Œçˆ¬æ¨“æ¢¯å¾ˆåƒåŠ›", "æ²’æ³•ä¸Šä¸‹æ¨“ï¼Œç”šè‡³åœ¨å®¶ä¹Ÿå¾—åè¼ªæ¤…"]},
    ],
    "ğŸšŒ å‡ºé–€èµ°èµ°èˆ‡ç”Ÿæ´»": [
        {"id": "b1", "label": "6. ä½¿ç”¨é›»è©±", "options": ["å¯ä»¥è‡ªå·±æ‰¾é›»è©±ç°¿ã€æ’¥è™Ÿèˆ‡å°ç­”", "åªæœƒæ¥é›»è©±ï¼Œæˆ–åªèƒ½æ’¥å¹¾å€‹ç†Ÿæ‚‰çš„è™Ÿç¢¼", "å®Œå…¨ä¸æœƒç”¨é›»è©±äº†"]},
        {"id": "b2", "label": "7. è™•ç†å®¶å‹™èˆ‡è¡£æœ", "options": ["èƒ½è‡ªå·±æƒåœ°ã€æ´—ç¢—æˆ–æ´—å°ä»¶è¡£æœ", "åªèƒ½åšç°¡å–®çš„æ”¶ç´ï¼Œç²—æ´»æ²’æ³•åš", "å®Œå…¨æ²’æ³•åšå®¶äº‹ï¼Œéƒ½è¦åˆ¥äººä»£å‹"]},
        {"id": "b3", "label": "8. å¤–å‡ºæ´»å‹•èˆ‡äº¤é€š", "options": ["èƒ½è‡ªå·±æ­å…¬è»Šã€æ·é‹æˆ–é¨è»Šå‡ºé é–€", "è¦äººé™ªæ‰æ•¢æ­è»Šï¼Œæˆ–åªèƒ½åœ¨å®¶é™„è¿‘èµ°", "å®Œå…¨æ²’æ³•è‡ªå·±å‡ºé–€"]},
        {"id": "b4", "label": "9. æœç”¨è—¥ç‰©", "options": ["æ™‚é–“åˆ°äº†æœƒè‡ªå·±æ‹¿è—¥åƒï¼Œåˆ†é‡ä¹Ÿæ­£ç¢º", "è¦äººå…ˆåˆ†è£å¥½ï¼Œæˆ–æ˜¯æé†’æ‰è¨˜å¾—åƒ", "å®Œå…¨æ²’æ³•è‡ªå·±ç®¡è—¥ï¼Œå¸¸åƒéŒ¯æˆ–å¿˜è¨˜"]},
        {"id": "b5", "label": "10. è™•ç†è²¡å‹™", "options": ["å»éŠ€è¡Œæˆ–è¶…å•†ç®—éŒ¢ã€ç¹³è²»éƒ½æ²’å•é¡Œ", "å°éŒ¢é‚„å¯ä»¥ï¼Œå¤§éŒ¢ï¼ˆå¦‚å»éŠ€è¡Œï¼‰æœƒç³Šå¡—", "ç¾åœ¨å®Œå…¨ä¸èƒ½è®“ä»–ç®¡éŒ¢äº†"]},
    ]
}

# ---------------------------------------------------------
# 3. ç¬¬ä¸€æ­¥ï¼šåŸºæœ¬èº«åˆ†
# ---------------------------------------------------------
st.subheader("ä¸€ã€ ç¢ºå®šè¦ªå±¬èº«åˆ†")
age = st.slider("è¦ªå±¬å¹´é½¡", 0, 125, 65)

col1, col2 = st.columns(2)
with col1:
    is_aboriginal = st.checkbox("å…·æœ‰åŸä½æ°‘èº«åˆ† (55æ­²ä»¥ä¸Šå³ç¬¦åˆ)")
    has_disability_card = st.checkbox("é ˜æœ‰èº«å¿ƒéšœç¤™è­‰æ˜")
with col2:
    is_pac = st.checkbox("æ€¥æ€§å¾ŒæœŸæ•´åˆç…§è­· (PAC) å°è±¡")
    dementia = st.checkbox("ç¶“é†«å¸«è¨ºæ–·ç‚ºå¤±æ™ºç—‡è€…")

# ---------------------------------------------------------
# 4. ç¬¬äºŒæ­¥ï¼šæ—¥å¸¸ç”Ÿæ´»è©•ä¼° (10é¡Œ)
# ---------------------------------------------------------
st.markdown("---")
st.subheader("äºŒã€ æ—¥å¸¸ç”Ÿæ´»è©•ä¼° (è¿‘ä¸€å€‹æœˆ)")

placeholder = "--- è«‹é¸æ“‡é•·è¼©ç‹€æ³ ---"
user_responses = {}

for category, q_list in questions.items():
    st.markdown(f'<div class="category-header"><h4>{category}</h4></div>', unsafe_allow_html=True)
    for q in q_list:
        user_responses[q["id"]] = st.selectbox(
            q["label"], 
            [placeholder] + q["options"], 
            key=q["id"]
        )

# ---------------------------------------------------------
# 5. é‚è¼¯é‹ç®— (ç²¾ç°¡ç‰ˆ 10 é¡Œæ¨¡å‹)
# ---------------------------------------------------------
def calculate_3_0_logic(responses, is_pac_status):
    is_group_match = (
        (age >= 65) or 
        (is_aboriginal and age >= 55) or 
        dementia or 
        has_disability_card or 
        is_pac_status
    )
    
    # è¨ˆç®—å¤±èƒ½æ¬Šé‡
    # é¸é … 0: è‡ªä¸»å®Œæˆ (0åˆ†)
    # é¸é … 1: éœ€è¦å”åŠ© (1åˆ†)
    # é¸é … 2: å®Œå…¨ç„¡æ³• (2åˆ†)
    score = 0
    for q_id, val in responses.items():
        # æ‰¾å‡ºè©²é¡Œçš„é¸é …åˆ—è¡¨
        options_list = []
        for cat in questions.values():
            for item in cat:
                if item["id"] == q_id:
                    options_list = item["options"]
        
        # æ ¹æ“šé¸å–çš„ç´¢å¼•è¨ˆç®—åŠ é‡å€¼
        choice_idx = options_list.index(val)
        score += (choice_idx * 1.5) # åŠ é‡ä¿‚æ•¸

    # å°‡ç¸½åˆ†è½‰åŒ–ç‚ºæ©Ÿç‡ (Sigmoid å‡½æ•¸æ¨¡æ“¬)
    z = -4.5 + score
    if is_pac_status: z += 1.5
    
    prob = 1 / (1 + np.exp(-z))
    return is_group_match, prob

# ---------------------------------------------------------
# 6. é€å‡ºçµæœ
# ---------------------------------------------------------
if st.button("âœ¨ é»æˆ‘é–‹å§‹è©•ä¼°"):
    if placeholder in user_responses.values():
        st.error("âš ï¸ é‚„æœ‰é¡Œç›®æ¼æ‰å›‰ï¼è«‹æŠŠ 10 å€‹é¡Œç›®éƒ½é¸å¥½å†é»æˆ‘ã€‚")
    else:
        is_match, prob = calculate_3_0_logic(user_responses, is_pac)
        
        st.markdown(f"""
        <div class="result-box">
            <div style='color: #666; font-size: 1.1rem;'>æ¨ä¼°æ”¿åºœè£œåŠ©åª’åˆåº¦</div>
            <div style='font-size: 3.8rem; font-weight: bold; color: #F39800;'>{prob*100:.1f}%</div>
        </div>
        """, unsafe_allow_html=True)
        
        if is_match and prob >= 0.4:
            st.success("âœ… **ç¬¦åˆé•·ç…§ 3.0 è£œåŠ©è³‡æ ¼ï¼**")
            st.markdown("""
                * **èº«åˆ†ç‹€æ…‹ï¼š** ç¬¦åˆæ”¿åºœæ”¶æ¡ˆæ—ç¾¤ã€‚
                * **å¤±èƒ½ç‹€æ³ï¼š** è©•ä¼°å·²é” CMS 2ç´šä»¥ä¸Šæ¨™æº–ã€‚
                * **å»ºè­°è¡Œå‹•ï¼š** æº–å‚™å¥½èº«åˆ†è­‰å­—è™Ÿèˆ‡åœ°å€ï¼Œæ’¥æ‰“ **1966** ç”³è«‹ã€‚
            """)
            st.balloons()
        elif is_match and prob < 0.4:
            st.warning("ğŸŸ¡ **èº«åˆ†ç¬¦åˆï¼Œä½†ç›®å‰å¤±èƒ½ç­‰ç´šè¼ƒè¼•ã€‚**")
            st.write("é›–ç„¶æ‚¨ç¬¦åˆæ”¶æ¡ˆèº«åˆ†ï¼Œä½†ç›®å‰é•·è¼©è‡ªç†èƒ½åŠ›ä¸éŒ¯ã€‚è‹¥ä¹‹å¾Œæœ‰é€€åŒ–ç¾è±¡ï¼Œè«‹éš¨æ™‚å›ä¾†é‡æ¸¬ã€‚")
        else:
            st.info("âšª **ç›®å‰å°šæœªç¬¦åˆè£œåŠ©é–€æª»ã€‚**")
            st.write("è‹¥æœªä¾†å¹´é½¡é”æ¨™æˆ–è¨ºæ–·å‡ºå¤±æ™º/èº«éšœè­‰æ˜ï¼Œå³å¯ç¬¦åˆç”³è«‹è³‡æ ¼ã€‚")

st.markdown("---")
st.markdown('<div style="text-align:center; font-size:0.8rem; color:#888;">ğŸ’Œ UIAå¥½åé‚Šï½œæœ¬è©•ä¼°åƒ…ä¾›åƒè€ƒï¼Œæ­£å¼çµæœä»¥æ”¿åºœè©•ä¼°ç‚ºæº–ã€‚</div>', unsafe_allow_html=True)
